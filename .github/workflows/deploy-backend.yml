name: Deploy DevTinder Backend

on:
  push:
    branches:
      - master

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Backend via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            bash -lc '
              set -e
              set -o pipefail
              
              echo " Deploying Backend"
              whoami
              echo " Home: $HOME"
              
              # Save current commit for rollback
              cd ~/DevTinder
              PREVIOUS_COMMIT=$(git rev-parse HEAD)
              
              echo " Node & npm check"
              node -v
              npm -v
              echo " Installing pm2..."
              npm install -g pm2
              pm2 -v
              
              echo " Pulling latest code..."
              git pull origin master || { echo " Git pull failed"; exit 1; }
              
              echo " Installing dependencies..."
              npm install --production || { echo " npm install failed"; exit 1; }
              
              echo " Restarting application..."
              pm2 delete DevTinder 2>/dev/null || true
              pm2 start npm --name DevTinder -- start
              pm2 save
              
              # Health check
              sleep 2
              if ! pm2 info DevTinder | grep -q "online"; then
                echo " Application failed to start"
                git checkout $PREVIOUS_COMMIT
                exit 1
              fi
              
              echo " Backend deployed successfully"
            '
